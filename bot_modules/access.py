# -*- coding: utf8 -*-
# –û–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –¥–æ—Å—Ç–æ—è–Ω–∏–µ 2023, –ê–ª–µ–∫—Å–µ–π –ë–µ–∑–±–æ—Ä–æ–¥–æ–≤ (Alexei Bezborodov) <AlexeiBv+mirocod_platform_bot@narod.ru> 

# –ü—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

from bot_sys import bot_bd, log, config, keyboard, user_access
from bot_modules import start, groups
from aiogram import Bot, types

import sqlite3

from aiogram.dispatcher import Dispatcher

bot = Bot(token=config.GetTelegramBotApiToken(), parse_mode=types.ParseMode.HTML)

# ---------------------------------------------------------
# –ë–î
init_bd_cmds = ["""CREATE TABLE IF NOT EXISTS module_access(
    modName TEXT,
    modAccess TEXT,
    UNIQUE(modName)
);""",
"INSERT OR IGNORE INTO module_access (modName, modAccess) VALUES ('access', 'other=-');"
]

# ---------------------------------------------------------
# –°–æ–æ–±—â–µ–Ω–∏—è

access_start_message = '''
<b> –ü—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Å—Ç–∞–¥–∏–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏</b>

–ü–æ–∫–∞ –º–æ–∂–µ—Ç–µ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ö–∞—Ä–¥–∫–æ—Ä–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º —á–µ—Ä–µ–∑ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î
'''

request_start_message = '''
**–ó–∞–¥–∞–π—Ç–µ –∑–∞–ø—Ä–æ—Å –∫ –ë–î**

–ú–æ–∂–µ—Ç–µ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Å–ª–µ–¥—É—é—â–∏–º–∏ —à–∞–±–ª–æ–Ω–∞–º–∏:
1. `SELECT * FROM users` - –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
'''

help_message = '''
–°—É—â–µ—Å—Ç–≤—É–µ—Ç –ë–î –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–∞–≤–∞–º–∏
`module_access (modName, modAccess)` - —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∞ –¥–ª—è –º–æ–¥—É–ª–µ–π

modAccess - —Å—Ç—Ä–æ–∫–∞
''' + user_access.user_access_readme

access_button_name = "üì∞ –î–æ—Å—Ç—É–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
sql_request_button_name = "üì∞ –ó–∞–ø—Ä–æ—Å –∫ –ë–î –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞"
help_button_name = "üì∞ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –¥–æ—Å—Ç—É–ø–∞"

# ---------------------------------------------------------
# –†–∞–±–æ—Ç–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏

def GetEditAccessKeyboardButtons(a_UserAccess):
    cur_buttons = [sql_request_button_name, help_button_name]
    mods = [start]
    return keyboard.MakeKeyboard(keyboard.GetButtons(mods, a_UserAccess) + cur_buttons)

# ---------------------------------------------------------
# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

# –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
async def AccessStart(a_Message):
    user_id = str(a_Message.from_user.id)
    user_access = GetUserAccess(a_Message.from_user.id)
    await bot.send_message(user_id, access_start_message, reply_markup = GetEditAccessKeyboardButtons(user_access))
# ---------------------------------------------------------
# –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö 


# ---------------------------------------------------------
# API

def GetUserAccess(a_UserID):
    return None

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
def GetInitBDCommands():
    return init_bd_cmds

# –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
def GetButtonNames(a_UserAccess):
    return [access_button_name]

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫
def RegisterHandlers(dp : Dispatcher):
    dp.register_message_handler(AccessStart, text = access_button_name)
    dp.register_message_handler(groups.RequestToBDTemplate(request_start_message), text = sql_request_button_name)
    dp.register_message_handler(groups.HelpTemplate(help_message, GetEditAccessKeyboardButtons), text = help_button_name)
